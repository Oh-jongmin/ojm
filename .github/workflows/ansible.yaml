name: Ansible Deployment

on:
  workflow_run:
    workflows: ["Terraform Deployment"]
    types:
      - completed

permissions:
  contents: read
  actions: read

jobs:
  ansible:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    timeout-minutes: 10
    steps:

      # âœ… 1. ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
      - name: Checkout repo
        uses: actions/checkout@v3

      # âœ… 2. SSH í‚¤ ë³µì› (KEY_PAIR ì‚¬ìš©)
      - name: ğŸ” Restore shared SSH key (KEY_PAIR)
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.KEY_PAIR }}" > ~/.ssh/pnp-key.pem
          chmod 600 ~/.ssh/pnp-key.pem

      # âœ… 3. GitHub â†’ Bastion ì ‘ì†ìš© SSH í‚¤ ë³µì‚¬
      - name: ğŸ” Copy SSH key to Bastion
        run: |
          scp -o StrictHostKeyChecking=no -i ~/.ssh/pnp-key.pem ~/.ssh/pnp-key.pem \
          ${{ secrets.BASTION_USERNAME }}@${{ secrets.BASTION_IP }}:~/.ssh/pnp-key.pem
      
      # âœ… 4. run-ansible.sh ë³µì‚¬
      - name: ğŸ” Copy run-ansible.sh to Bastion
        run: |
          scp -o StrictHostKeyChecking=no -i ~/.ssh/pnp-key.pem scripts/run-ansible.sh \
          ${{ secrets.BASTION_USERNAME }}@${{ secrets.BASTION_IP }}:~/run-ansible.sh

      # âœ… 5. Bastionì—ì„œ ì‹¤í–‰ (MGMT_IP/PNP_KEY ì „ë‹¬)
      - name: ğŸš€ Execute run-ansible.sh on Bastion
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/pnp-key.pem \
          ${{ secrets.BASTION_USERNAME }}@${{ secrets.BASTION_IP }} \
          "export MGMT_IP='${{ secrets.MGMT_IP }}'; \
          export PNP_KEY='${{ secrets.KEY_PAIR }}'; \
          export AWS_ACCESS_KEY_ID='${{ secrets.AWS_ACCESS_KEY_ID }}'; \
          export AWS_SECRET_ACCESS_KEY='${{ secrets.AWS_SECRET_ACCESS_KEY }}'; \
          bash ~/run-ansible.sh"
