name: Ansible Deployment

on:
  push:
    branches: [main]
    paths:
      - 'ansible/**'
      - '.github/workflows/ansible.yaml'

permissions:
  contents: read
  actions: read

jobs:
  ansible:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    timeout-minutes: 10
    steps:

      # ‚úÖ 1. ÏΩîÎìú Í∞ÄÏ†∏Ïò§Í∏∞
      - name: Checkout repo
        uses: actions/checkout@v3

      # ‚úÖ 2. SSH ÌÇ§ Î≥µÏõê (KEY_PAIR ÏÇ¨Ïö©)
      - name: üîê Restore shared SSH key (KEY_PAIR)
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.KEY_PAIR }}" > ~/.ssh/pnp-key.pem
          chmod 600 ~/.ssh/pnp-key.pem

      # ‚úÖ 3. GitHub ‚Üí Bastion Ï†ëÏÜçÏö© SSH ÌÇ§ Î≥µÏÇ¨
      - name: üîê Copy SSH key to Bastion
        run: |
          scp -o StrictHostKeyChecking=no -i ~/.ssh/pnp-key.pem ~/.ssh/pnp-key.pem \
          ${{ secrets.BASTION_USERNAME }}@${{ secrets.BASTION_IP }}:~/.ssh/pnp-key.pem
      
      # ‚úÖ 4. run-ansible.sh Î≥µÏÇ¨
      - name: üîê Copy run-ansible.sh to Bastion
        run: |
          scp -o StrictHostKeyChecking=no -i ~/.ssh/pnp-key.pem scripts/run-ansible.sh \
          ${{ secrets.BASTION_USERNAME }}@${{ secrets.BASTION_IP }}:~/run-ansible.sh

      # ‚úÖ 5. BastionÏóêÏÑú Ïã§Ìñâ (MGMT_IP/PNP_KEY Ï†ÑÎã¨)
      - name: üöÄ Execute run-ansible.sh on Bastion
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/pnp-key.pem \
          ${{ secrets.BASTION_USERNAME }}@${{ secrets.BASTION_IP }} \
          "export MGMT_IP='${{ secrets.MGMT_IP }}'; \
          export PNP_KEY='${{ secrets.KEY_PAIR }}'; \
          export AWS_ACCESS_KEY_ID='${{ secrets.AWS_ACCESS_KEY_ID }}'; \
          export AWS_SECRET_ACCESS_KEY='${{ secrets.AWS_SECRET_ACCESS_KEY }}'; \
          export AWS_ACCOUNT_ID='${{ secrets.AWS_ACCOUNT_ID }}'; \
          export ARGOCD_GH_CLIENT_ID='${{ secrets.ARGOCD_GH_CLIENT_ID }}'; \
          export ARGOCD_GH_CLIENT_SECRET='${{ SECRETS.ARGOCD_GH_CLIENT_SECRET }}'; \
          bash ~/run-ansible.sh"
